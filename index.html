<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; connect-src *; img-src 'self' data: blob:;">
  <title>Tower Defense</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a1a;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }

    .title-bar {
      -webkit-app-region: drag;
      height: 32px;
      background: linear-gradient(90deg, #1a1a2e, #16213e);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px;
    }

    .title-bar h1 {
      font-size: 12px;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
    }

    .window-controls {
      -webkit-app-region: no-drag;
      display: flex;
      gap: 6px;
    }

    .window-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
    }

    .window-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .window-btn.close:hover { background: #dc2626; }

    /* Auth Screen */
    .auth-screen {
      height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #1a237e 0%, #0d47a1 50%, #01579b 100%);
      padding: 20px;
    }

    .game-logo {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #ea580c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .version-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 30px;
    }

    .version-badge .dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
    }

    .auth-card {
      width: 100%;
      max-width: 380px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }

    .btn {
      width: 100%;
      padding: 14px 18px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-discord {
      background: #5865F2;
      color: #fff;
    }

    .btn-discord:hover {
      background: #4752c4;
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(88, 101, 242, 0.5);
    }

    .btn-discord svg { width: 20px; height: 20px; }

    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: rgba(255,255,255,0.3);
      font-size: 12px;
    }

    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.1);
    }

    .divider span { padding: 0 14px; }

    .input-group { margin-bottom: 14px; }

    .input-group label {
      display: block;
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 14px;
      font-family: inherit;
    }

    .input-group input:focus {
      outline: none;
      border-color: #5865F2;
      box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.2);
    }

    .status-message {
      min-height: 24px;
      margin: 14px 0;
      font-size: 13px;
      text-align: center;
    }

    .status-message.error { color: #f87171; }
    .status-message.success { color: #4ade80; }

    .btn-submit {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
    }

    .btn-submit:hover {
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    /* Main Game Screen */
    .game-screen {
      display: none;
      height: calc(100vh - 32px);
      flex-direction: column;
      background: linear-gradient(180deg, #1a237e 0%, #0d47a1 100%);
    }

    .game-screen.visible { display: flex; }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
    }

    .profile-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(0,0,0,0.3);
      border: 2px solid #fbbf24;
      border-radius: 30px;
      padding: 6px 16px 6px 6px;
      cursor: pointer;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-name { font-size: 14px; font-weight: 700; }
    .profile-level { font-size: 11px; color: #fbbf24; }

    .resources { display: flex; gap: 10px; }

    .resource {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.3);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
    }

    .resource.gold { color: #fbbf24; border: 1px solid rgba(251,191,36,0.3); }
    .resource.gems { color: #a78bfa; border: 1px solid rgba(167,139,250,0.3); }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .play-card {
      text-align: center;
      background: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 24px;
      padding: 40px 60px;
    }

    .play-card h2 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .play-card p {
      color: rgba(255,255,255,0.6);
      margin-bottom: 30px;
    }

    .btn-play {
      padding: 20px 60px;
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 8px 30px rgba(251,191,36,0.4);
    }

    .btn-play:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(251,191,36,0.6);
    }

    /* In-Game View */
    .game-view {
      display: none;
      height: calc(100vh - 32px);
      flex-direction: column;
      background: #000;
    }

    .game-view.visible { display: flex; }

    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: rgba(0,0,0,0.8);
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-back:hover { background: rgba(255,255,255,0.2); }

    .game-title {
      font-size: 16px;
      font-weight: 700;
      color: #fbbf24;
    }

    .game-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .game-container webview, .game-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .loading-game {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
    }

    .loading-game .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #fbbf24;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Title Bar -->
  <div class="title-bar">
    <h1>üè∞ Tower Defense</h1>
    <div class="window-controls">
      <button class="window-btn" id="minimize-btn">‚îÄ</button>
      <button class="window-btn" id="maximize-btn">‚ñ°</button>
      <button class="window-btn close" id="close-btn">‚úï</button>
    </div>
  </div>

  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <h1 class="game-logo">Tower Defense</h1>
    <div class="version-badge">
      <span class="dot"></span>
      <span id="version-text">–í–µ—Ä—Å–∏—è 1.2.0</span>
    </div>

    <div class="auth-card">
      <button class="btn btn-discord" id="discord-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
        </svg>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord
      </button>

      <div class="divider"><span>–∏–ª–∏</span></div>

      <form id="login-form">
        <div class="input-group">
          <label>–õ–æ–≥–∏–Ω</label>
          <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
        </div>
        <div class="input-group">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
        </div>
        <div class="status-message" id="status-message"></div>
        <button type="submit" class="btn btn-submit">–í–æ–π—Ç–∏</button>
      </form>
    </div>
  </div>

  <!-- Main Game Screen (Menu) -->
  <div class="game-screen" id="game-screen">
    <div class="top-bar">
      <div class="profile-btn">
        <div class="profile-avatar" id="profile-avatar">?</div>
        <div class="profile-info">
          <div class="profile-name" id="profile-name">–ò–≥—Ä–æ–∫</div>
          <div class="profile-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
        </div>
      </div>
      <div class="resources">
        <div class="resource gold">üí∞ <span id="gold-count">1000</span></div>
        <div class="resource gems">üíé <span id="gems-count">50</span></div>
      </div>
    </div>

    <div class="main-area">
      <div class="play-card">
        <h2>üè∞ Tower Defense</h2>
        <p>–ó–∞—â–∏—Ç–∏ –∑–∞–º–æ–∫ –æ—Ç –≤–æ–ª–Ω –≤—Ä–∞–≥–æ–≤!</p>
        <button class="btn-play" id="play-btn">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <!-- In-Game View -->
  <div class="game-view" id="game-view">
    <div class="game-header">
      <button class="btn-back" id="back-btn">‚Üê –ú–µ–Ω—é</button>
      <div class="game-title">Tower Defense</div>
      <div></div>
    </div>
    <div class="game-container" id="game-container">
      <div class="loading-game" id="game-loading">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</p>
      </div>
      <iframe id="game-frame" class="hidden" src=""></iframe>
    </div>
  </div>

  <script>
    const { electronAPI } = window;

    // Screens
    const authScreen = document.getElementById('auth-screen');
    const gameScreen = document.getElementById('game-screen');
    const gameView = document.getElementById('game-view');

    // Elements
    const discordBtn = document.getElementById('discord-btn');
    const loginForm = document.getElementById('login-form');
    const statusMessage = document.getElementById('status-message');
    const playBtn = document.getElementById('play-btn');
    const backBtn = document.getElementById('back-btn');
    const gameFrame = document.getElementById('game-frame');
    const gameLoading = document.getElementById('game-loading');
    const profileName = document.getElementById('profile-name');
    const profileAvatar = document.getElementById('profile-avatar');

    // User data
    let currentUser = null;

    // Init
    async function init() {
      const version = await electronAPI.getAppVersion();
      document.getElementById('version-text').textContent = `–í–µ—Ä—Å–∏—è ${version}`;
      
      // Check saved login
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showGameScreen();
      }
    }

    function showAuthScreen() {
      authScreen.style.display = 'flex';
      gameScreen.classList.remove('visible');
      gameView.classList.remove('visible');
    }

    function showGameScreen() {
      authScreen.style.display = 'none';
      gameScreen.classList.add('visible');
      gameView.classList.remove('visible');
      
      if (currentUser) {
        profileName.textContent = currentUser.username || currentUser.discord_username || '–ò–≥—Ä–æ–∫';
        profileAvatar.textContent = (currentUser.username || 'U')[0].toUpperCase();
        if (currentUser.avatar) {
          profileAvatar.innerHTML = `<img src="${currentUser.avatar}">`;
        }
      }
    }

    function showGameView() {
      authScreen.style.display = 'none';
      gameScreen.classList.remove('visible');
      gameView.classList.add('visible');
      
      // Load game
      gameLoading.classList.remove('hidden');
      gameFrame.classList.add('hidden');
      gameFrame.src = 'game-web/index.html';
      
      gameFrame.onload = () => {
        gameLoading.classList.add('hidden');
        gameFrame.classList.remove('hidden');
      };
    }

    // Discord Login
    discordBtn.addEventListener('click', async () => {
      discordBtn.disabled = true;
      discordBtn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
      
      try {
        const result = await electronAPI.discordLogin();
        if (result.success) {
          currentUser = result.user;
          localStorage.setItem('user', JSON.stringify(currentUser));
          localStorage.setItem('token', result.token);
          showGameScreen();
        } else {
          statusMessage.textContent = result.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
          statusMessage.className = 'status-message error';
        }
      } catch (e) {
        statusMessage.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        statusMessage.className = 'status-message error';
      }
      
      discordBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37..."/></svg> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord`;
      discordBtn.disabled = false;
    });

    // Form Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const res = await fetch('http://103.137.251.209/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        
        if (data.success) {
          currentUser = data.user;
          localStorage.setItem('user', JSON.stringify(currentUser));
          localStorage.setItem('token', data.token);
          showGameScreen();
        } else {
          statusMessage.textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
          statusMessage.className = 'status-message error';
        }
      } catch (e) {
        statusMessage.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        statusMessage.className = 'status-message error';
      }
    });

    // Play button
    playBtn.addEventListener('click', () => {
      showGameView();
    });

    // Back button
    backBtn.addEventListener('click', () => {
      gameFrame.src = '';
      showGameScreen();
    });

    // Window controls
    document.getElementById('minimize-btn').addEventListener('click', () => electronAPI.minimizeApp());
    document.getElementById('maximize-btn').addEventListener('click', () => electronAPI.maximizeApp());
    document.getElementById('close-btn').addEventListener('click', () => electronAPI.closeApp());

    // Update status
    electronAPI.onUpdateStatus((status) => {
      console.log('Update status:', status);
    });

    init();
  </script>
</body>
</html>
